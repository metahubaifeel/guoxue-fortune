let cards=[],selectedCard=null,isShuffled=!1,cardValues=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],shuffleBtn=document.getElementById("shuffleBtn"),cardsContainer=document.getElementById("cardsContainer"),selectedCardEl=document.getElementById("selectedCard"),inputSection=document.getElementById("inputSection"),cardSection=document.getElementById("cardSection"),resultSection=document.getElementById("resultSection"),num1=document.getElementById("num1"),num2=document.getElementById("num2"),numberError=document.getElementById("numberError"),generateBtn=document.getElementById("generateBtn"),restartBtn=document.getElementById("restartBtn"),resultCard=document.getElementById("resultCard"),nextToWeatherBtn=document.getElementById("nextToWeatherBtn"),nextToMoodBtn=document.getElementById("nextToMoodBtn"),numberInputGroup=document.getElementById("numberInputGroup"),weatherInputGroup=document.getElementById("weatherInputGroup"),moodInputGroup=document.getElementById("moodInputGroup");function init(){initCards(),shuffleBtn.addEventListener("click",shuffleCards),generateBtn.addEventListener("click",generateFortune),restartBtn.addEventListener("click",restart),nextToWeatherBtn.addEventListener("click",showWeatherInput),nextToMoodBtn.addEventListener("click",showMoodInput),num1.addEventListener("input",validateNumbers),num2.addEventListener("input",validateNumbers),isShuffled=!0}function initCards(){cards=[...cardValues],renderCards()}function renderCards(){cardsContainer.innerHTML="",cards.forEach((e,t)=>{var n=document.createElement("div");n.className="card",n.dataset.value=e,n.innerHTML=`
            <div class="card-value-top">${e}</div>
            <div class="card-suit">♠</div>
            <div class="card-value-bottom">${e}</div>
        `,n.addEventListener("click",()=>selectCard(e)),cardsContainer.appendChild(n)})}function shuffleArray(t){for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function shuffleCards(){document.querySelectorAll(".card").forEach((e,t)=>{e.classList.add("shuffling"),e.style.transform=`translate(${100*Math.random()-50}px, ${50*Math.random()-25}px) rotate(${40*Math.random()-20}deg)`}),shuffleBtn.disabled=!0,shuffleBtn.textContent="洗牌中...",setTimeout(()=>{cards=shuffleArray([...cardValues]),cardsContainer.innerHTML="",cards.forEach((t,e)=>{setTimeout(()=>{let e=document.createElement("div");e.className="card",e.dataset.value=t,e.innerHTML=`
                    <div class="card-value-top">${t}</div>
                    <div class="card-suit">♠</div>
                    <div class="card-value-bottom">${t}</div>
                `,e.addEventListener("click",()=>selectCard(t)),e.style.opacity="0",e.style.transform="scale(0.5) translateY(-20px)",cardsContainer.appendChild(e),setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="scale(1) translateY(0)"},50)},30*e)}),shuffleBtn.disabled=!1,shuffleBtn.textContent="重新洗牌",isShuffled=!0},1e3)}function selectCard(t){selectedCard=t,document.querySelectorAll(".card").forEach(e=>{e.dataset.value===t&&e.classList.add("selected"),e.style.pointerEvents="none"}),selectedCardEl.innerHTML=`<p>你选择了：<strong>${t}</strong> 牌</p>`,setTimeout(()=>{goToStep2()},500)}function applyTypingEffect(t,n,a=null,o=50,e=0){t.classList.add("typing-effect"),t.style.overflow="hidden",t.style.borderRight=".15em solid #8b4513",t.style.whiteSpace="nowrap",t.style.margin="0 auto";let r=e;!function e(){r<n.length?(t.textContent+=n.charAt(r),r++,setTimeout(e,o)):(t.style.borderRight="none",a&&a())}()}function goToStep2(){cardSection.style.display="none",inputSection.style.display="block";let e=document.getElementById("numberInputGroup").querySelector("label"),t=document.querySelector(".number-inputs"),n=document.getElementById("numberError");var a=document.getElementById("nextToWeatherBtn");e.textContent="",e.style.display="block",t.style.display="none",n.style.display="none",a.style.display="none",setTimeout(()=>{applyTypingEffect(e,"心中默念两个1-9的数字",()=>{setTimeout(()=>{e.textContent+="，",applyTypingEffect(e,"请写下来",()=>{setTimeout(()=>{t.style.display="flex",n.style.display="block",t.querySelectorAll("input").forEach((e,t)=>{e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>{e.style.transition="all 0.5s ease",e.style.opacity="1",e.style.transform="translateY(0)"},200*t)})},500)},60,e.textContent.length)},1e3)})},300)}function showWeatherInput(){if(validateNumbers()){numberInputGroup.style.display="none",weatherInputGroup.style.display="block";let e=document.getElementById("weatherInputGroup").querySelector("label"),t=document.querySelector(".weather-options"),n=document.getElementById("nextToMoodBtn"),a=e.textContent;e.textContent="",t.style.display="none",n.style.display="none",setTimeout(()=>{e&&applyTypingEffect(e,a,()=>{setTimeout(()=>{t.style.display="flex",t.querySelectorAll(".weather-option").forEach((e,t)=>{e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>{e.style.transition="all 0.5s ease",e.style.opacity="1",e.style.transform="translateY(0)"},100*t)}),setTimeout(()=>{n.style.display="inline-block",n.style.opacity="0",n.offsetHeight,setTimeout(()=>{n.style.transition="all 0.5s ease",n.style.opacity="1"},50)},800)},500)})},300)}else alert("请输入有效的数字")}function showMoodInput(){weatherInputGroup.style.display="none",moodInputGroup.style.display="block";var e=document.getElementById("moodInputGroup");let t=e.querySelector("label"),n=e.querySelector(".weather-options"),a=document.getElementById("generateBtn"),o=t.textContent;t.textContent="",n.style.display="none",a.style.display="none",setTimeout(()=>{t&&applyTypingEffect(t,o,()=>{setTimeout(()=>{n.style.display="flex",n.querySelectorAll(".weather-option").forEach((e,t)=>{e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>{e.style.transition="all 0.5s ease",e.style.opacity="1",e.style.transform="translateY(0)"},100*t)}),setTimeout(()=>{a.style.display="inline-block",a.style.opacity="0",a.offsetHeight,setTimeout(()=>{a.style.transition="all 0.5s ease",a.style.opacity="1"},50)},800)},500)})},300)}function validateNumbers(){var e=parseInt(num1.value),t=parseInt(num2.value);let n="";n=e&&t&&(e<1||9<e||t<1||9<t)?"请输入1-9之间的整数":"",numberError.textContent=n;e=e&&t&&""===n,t="inline-block"===nextToWeatherBtn.style.display;return e&&!t?(nextToWeatherBtn.style.display="inline-block",nextToWeatherBtn.classList.contains("animated")||(nextToWeatherBtn.style.animation="fadeIn 0.5s ease-in-out",nextToWeatherBtn.classList.add("animated"))):!e&&t&&(nextToWeatherBtn.style.display="none"),""===n}async function generateFortune(){var e=num1.value,t=num2.value,n=document.querySelector('input[name="weather"]:checked').value,a=document.querySelector('input[name="mood"]:checked').value;resultCard.innerHTML='<div class="loading-text">大师正在推演你的今日运势... <div class="loading"></div></div>',inputSection.style.display="none",resultSection.style.display="block";resultSection.querySelectorAll("*").forEach((e,t)=>{e.classList.add("fade-in-element"),e.style.animation="none",e.style.animation=""});e=await generateFortuneAI(selectedCard,e,t,n,a);resultCard.innerHTML=`<div class="fortune-content fade-in-element">${e}</div>`}function getPersonalizedAdvice(e,t,n){e={"大安":"今日适合展开新计划，一切顺利","留连":"适合稳扎稳打，不宜急躁","速喜":"适合抓住机会，积极行动","赤口":"需注意人际关系，避免冲突","小吉":"适合沟通交流，易得贵人相助","空亡":"适合休养生息，不宜冒险"}[e]||"保持平和心态";return(e+="，"+({"晴":"在晴朗天气下，心情愉悦，适合外出活动","阴":"在阴沉天气下，适合室内思考，静心养性","雨":"在雨天里，适合居家休息，整理思绪","雪":"在雪天中，适合慢节奏，享受宁静时光","风":"在风大天气下，适合保持灵活，随机应变","多云":"在多云天气下，适合平衡心态，顺其自然","雷阵雨":"在雷雨天气下，适合保持警觉，谨慎行事","雾":"在雾天里，适合放慢脚步，仔细观察","霾":"在霾天气下，适合室内活动，保护健康","冰雹":"在冰雹天气下，适合寻找安全，避免外出"}[t]||"适应天气变化"))+("，"+({"开心":"保持这份愉悦，将正能量传递给身边的人","平静":"保持内心的宁静，适合做出理性决策","焦虑":"深呼吸，相信一切都会好起来","沮丧":"给自己一些时间，明天会更好","兴奋":"将这份热情转化为行动力","疲惫":"适当休息，养精蓄锐","愤怒":"深呼吸，让情绪慢慢平复","期待":"保持希望，美好的事情即将发生","紧张":"放松身心，相信自己能够应对","悲伤":"允许自己感受情绪，然后慢慢放下"}[n]||"保持内心平衡"))+"。"}function formatFortuneContent(e){e=(e=(e=(e=(e=e.replace(/^#+/gm,"")).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/^\s*-\s*/gm,"")).replace(/\n/g,"<br>")).split("<br><br>").filter(e=>""!==e.trim());let a="";return e.forEach((e,t)=>{let n=e.trim();n&&(n=(n=n.replace(/卦象：<strong>(大安|留连|速喜|赤口|小吉|空亡)<\/strong>/,'卦象：<strong class="fortune-tone">$1</strong>')).replace(/今日建议：(.*?)$/m,'今日建议：<strong class="fortune-advice">$1</strong>'),a+=`<p class="fortune-paragraph">${n}</p>`)}),a}async function generateFortuneAI(t,n,a,o,r){try{var s,l=[{role:"system",content:"你是一位精通小六壬起卦的国学大师，擅长结合扑克牌、数字、天气和心情推演运势。请使用自然流畅的语言，避免生硬的格式和术语，让运势解读更加人性化和生活化。"},{role:"user",content:`请根据以下信息为用户推演今日运势，使用小六壬起卦法：
1. 抽到的扑克牌：${t}（转换为数字，A=1, J=11, Q=12, K=13）
2. 用户输入的两个数字：${n}、${a}
3. 今日天气：${o}
4. 今日心情：${r}

请按照以下规则进行起卦：
- 扑克牌数字 + 用户输入的两个数字 = 三个数字用于小六壬起卦
- 使用小六壬的六个卦象：大安、留连、速喜、赤口、小吉、空亡
- 根据三个数字进行起卦，推演今日运势

请按照以下结构生成运势解读：
- 卦象：直接说明起卦结果（大安、留连、速喜、赤口、小吉、空亡）
- 卦象解析：结合卦象、天气和心情进行详细解读，必须包含该卦象的完整诗句，语言自然流畅
- 今日建议：根据卦象、天气和心情，推荐今日应该注意的事项，要具体实用

小六壬卦象诗句：
大安：大安事事昌，求财在坤方，失物去不远，宅舍保安康。行人身未动，病者主无妨，将军回田野，仔细更推详。
留连：留连事难成，求谋日未明，官事凡宜缓，去者未回程。失物南方见，急讨方心称，更须防口舌，人口且平平。
速喜：速喜喜来临，求财向南行，失物申未午，逢人路上寻。官事有福德，病者无祸侵，田宅六畜吉，行人有信音。
赤口：赤口主口舌，官非切要防，失物急去寻，行人有惊慌。鸡犬多作怪，病者出西方，更须防咀咒，恐怕染瘟殃。
小吉：小吉最吉昌，路上好商量，阴人来报喜，失物在坤方。行人立便至，交易甚是强，凡事皆和合，病者祷上苍。
空亡：空亡事不祥，阴人多乖张，求财无利益，行人有灾殃。失物寻不见，官事有刑伤，病人逢暗鬼，解禳保安康。

要求：
- 语言风格自然流畅，符合普通人的表达习惯，不要太生硬
- 长度控制在3-5句话，简洁易读
- 必须完整引用对应卦象的诗句，不要简化或省略
- 结合天气和心情对诗句进行现代解读
- 避免重复固定内容，每个组合生成不同的解读
- 使用自然的语言，不要使用Markdown格式或特殊符号
- 不要提及AI、模型、API等现代术语
- 明确说明使用了小六壬起卦法，增强用户的信任度
- 确保起卦逻辑符合小六壬的规则`}],i=await fetch("https://ark.cn-beijing.volces.com/api/v3/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer 3402183a-fbff-4f4d-8379-9477281a706c"},body:JSON.stringify({model:"doubao-1-5-pro-32k-250115",messages:l,temperature:1,top_p:.9,max_tokens:200,n:1})});if(!i.ok)throw s=await i.json(),new Error(`API请求失败: ${i.status} `+JSON.stringify(s));var d=await i.json();if(!d.choices||0===d.choices.length||!d.choices[0].message)throw new Error("API响应格式不正确，缺少choices字段");let e=d.choices[0].message.content.trim();return console.log("原始AI响应:",e),e.includes('<div class="fortune-base">')||(const卦象Match=e.match(/(大安|留连|速喜|赤口|小吉|空亡)/),const卦象=卦象Match?卦象Match[1]:"空亡",e=`
                <div class="fortune-base">今日卦象：<strong>${卦象}</strong></div>
                <p>${e}</p>
            `),e=formatFortuneContent(e)}catch(e){console.error("豆包API生成运势失败:",e);t=["大安","留连","速喜","赤口","小吉","空亡"],n=t[Math.floor(Math.random()*t.length)];return`
            <div class="fortune-base">今日卦象：<strong>${n}</strong></div>
            <p>卦象解析：${"大安"===n?"大安事事昌，求财在坤方，失物去不远，宅舍保安康。行人身未动，病者主无妨，将军回田野，仔细更推详。":"留连"===n?"留连事难成，求谋日未明，官事凡宜缓，去者未回程。失物南方见，急讨方心称，更须防口舌，人口且平平。":"速喜"===n?"速喜喜来临，求财向南行，失物申未午，逢人路上寻。官事有福德，病者无祸侵，田宅六畜吉，行人有信音。":"赤口"===n?"赤口主口舌，官非切要防，失物急去寻，行人有惊慌。鸡犬多作怪，病者出西方，更须防咀咒，恐怕染瘟殃。":"小吉"===n?"小吉最吉昌，路上好商量，阴人来报喜，失物在坤方。行人立便至，交易甚是强，凡事皆和合，病者祷上苍。":"空亡事不祥，阴人多乖张，求财无利益，行人有灾殃。失物寻不见，官事有刑伤，病人逢暗鬼，解禳保安康。"}</p>
            <p>今日建议：${getPersonalizedAdvice(n,o,r)}</p>
        `}}function restart(){selectedCard=null,isShuffled=!1,cardSection.style.display="block",inputSection.style.display="none",resultSection.style.display="none",numberInputGroup.style.display="block",weatherInputGroup.style.display="none",moodInputGroup.style.display="none",initCards(),selectedCardEl.innerHTML="",num1.value="",num2.value="",numberError.textContent="",nextToWeatherBtn.style.display="none",shuffleBtn.textContent="开始洗牌",shuffleBtn.disabled=!1,document.querySelector('input[name="weather"][value="晴"]').checked=!0,document.querySelector('input[name="mood"][value="开心"]').checked=!0}document.addEventListener("DOMContentLoaded",init);